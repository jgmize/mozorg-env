#!/bin/bash -ex
SCRIPT_DIR=${0%/*}
. $SCRIPT_DIR/b2d
BEDROCK=$SCRIPT_DIR/../apache/bedrock/base/bedrock
VOLUMES=/var/lib/docker/volumes
TARGET=$VOLUMES/mozilla
MOZCOM=$SCRIPT_DIR/../apache/mozilla.com
B2D_IP=$(boot2docker ip)
boot2docker ssh "sudo mkdir -p $TARGET && sudo chown -R docker $VOLUMES && tce-load -wi rsync"

if [ ! -e $BEDROCK ]; then
    git clone --recursive https://github.com/mozilla/bedrock $BEDROCK
fi

#TODO: eliminate settings/local.py in favor of env variables
if [ ! -e $BEDROCK/bedrock/settings/local.py ]; then
    cp $BEDROCK/bedrock/settings/local.py-dist $BEDROCK/bedrock/settings/local.py
fi

if [ ! -e $MOZCOM ]; then
    svn co https://svn.mozilla.org/projects/mozilla.com/trunk $MOZCOM
    cd $MOZCOM/includes
    cp config.inc.php-dist config.inc.php
    cd ..
    svn co https://svn.mozilla.org/projects/mozilla.org/trunk org
    cd org/includes
    cp config.inc.php-dist config.inc.php
    cd $SCRIPT_DIR/..
fi

if [ ! "$(which fswatch)" ]; then
    if [ $(uname) == "Darwin" ]; then
        if [ ! "$(which brew)" ]; then
            ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        fi
        brew install fswatch
    else
        echo This script requires fswatch: https://github.com/emcrisostomo/fswatch/blob/master/INSTALL
        exit 1
    fi
fi

fswatch_b2d_rsync() {
    RSYNC_ARGS=(
        -e "ssh -i $HOME/.ssh/id_boot2docker"
        -avzk
        --exclude .git
        --exclude .svn
        #--exclude-from .gitignore  # this excludes settings/local.py
        $1 docker@$B2D_IP:$2)
    rsync "${RSYNC_ARGS[@]}"
    fswatch -o $1 | xargs -n1 -I{} rsync "${RSYNC_ARGS[@]}" &
}

fswatch_b2d_rsync $BEDROCK $TARGET
fswatch_b2d_rsync $MOZCOM $TARGET
