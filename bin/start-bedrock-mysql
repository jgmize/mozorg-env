#!/bin/bash -ex
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT
BIN=${0%/*}
PROJECT=mozorg
BEDROCK_PATH=/app

if [ -e $BIN/../.env ]; then
    . $BIN/../.env
fi

. $BIN/bedrock-init
. $BIN/b2d
if [ $B2D ]; then
    $BIN/b2d-fswatch-rsync $BEDROCK &
fi

if [ ! "$(docker images | grep ${PROJECT}_bedrock)" ]; then
   $BIN/compose build bedrock
fi

if [ ! "$(docker images | grep mysql)" ]; then
   $BIN/compose pull mysql
fi

$BIN/compose up mysql bedrock &
sleep 10 #TODO: something more deterministic

docker exec ${PROJECT}_mysql_1 bash -c 'echo "create database if not exists bedrock;" | mysql --password=$MYSQL_ROOT_PASSWORD'

docker exec ${PROJECT}_bedrock_1 bash -c "cd /app; if [ ! -e .synced ]; then bin/sync_all && touch .synced; fi"
echo Ctrl+C to exit
cat # wait until killed
