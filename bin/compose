#!/bin/bash -ex
BIN=${0%/*}
PROJECT=mozorg

if [ -e $BIN/../.env ]; then
   . $BIN/../.env
fi

if [ ! "${COMPOSE_ARGS[@]}" ]; then
    COMPOSE_ARGS=(-p $PROJECT)
fi

if [ "$1" == "-b" ]; then
    BUILD=1
    shift
elif [ "$1" == "build" ]; then
    BUILD=1
fi

if [[ ! " ${COMPOSE_ARGS[@]}" =~ " -f " ]]; then
    . $BIN/b2d
    if [ $B2D ]; then
        if [ $BUILD ]; then
            COMPOSE_ARGS+=(-f $BIN/../b2d-build.yml)
        else
            COMPOSE_ARGS+=(-f $BIN/../b2d.yml)
        fi
    else
        if [ $BUILD ]; then
            COMPOSE_ARGS+=(-f $BIN/../build.yml)
        else
            COMPOSE_ARGS+=(-f $BIN/../docker-compose.yml)
        fi
    fi
fi

if [ ! "$(which docker-compose)" ]; then
    curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` \
         > /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi

COMPOSE_ARGS+=($@)
docker-compose ${COMPOSE_ARGS[@]}
