#!/bin/bash -ex
BIN=${0%/*}
HTTPDCONF=$BIN/../apache/etc/httpd/conf
PROJECT=mozorg
BEDROCK_PATH=/data/www/www.mozilla.org-django/bedrock
trap "trap - SIGTERM && kill -- -$$ && $BIN/compose stop" SIGINT SIGTERM EXIT

if [ -e $BIN/../.env ]; then
    . $BIN/../.env
fi

. $BIN/bedrock-mysql-init
. $BIN/mozcom-init

if [ $B2D ]; then
    $BIN/b2d-fswatch-rsync $BEDROCK &
    $BIN/b2d-fswatch-rsync $MOZCOM &
fi

if [ ! "$(docker images | grep ${PROJECT}_apache)" ]; then
    # TODO: file PR to add httpd conf files to bedrock
    if [ ! -e $BEDROCK/etc/httpd/httpd.conf ]; then
        cp $HTTPDCONF/httpd.conf $BEDROCK/etc/httpd/httpd.conf
    fi

    if [ ! -e $BEDROCK/etc/httpd/www.mozilla.org.conf ]; then
        cp $HTTPDCONF.d/www.mozilla.org.conf $BEDROCK/etc/httpd/www.mozilla.org.conf
    fi
fi

if [ "$1" == "-b" ]; then
    if [ ! -d $BIN/../apache/rpm ]; then
        cd $BIN/../apache
        curl -sS https://people.mozilla.org/~jmize/bedrock-apache-rpms.tgz | tar xz
    fi
    $BIN/compose build apache
else
    $BIN/compose pull apache
fi

$BIN/compose $1 up apache &
sleep 10 #TODO: something more deterministic

$BIN/dsh apache ./manage.py migrate --noinput
$BIN/dsh apache ./manage.py update_product_details
$BIN/dsh apache ./manage.py collectstatic --noinput

if [ "$B2D" == "1" ]; then
    open http://mozilla.local
else
    echo You can now open http://mozilla.local in your browser
fi

echo Ctrl+C to exit
cat # wait until killed
